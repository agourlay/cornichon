<!DOCTYPE html><html><head><title>Cornichon: PBT</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Arnaud Gourlay" /><meta name="description" content="An extensible Scala DSL for testing JSON HTTP APIs." /><meta name="og:image" content="/cornichon/img/poster.png" /><meta name="image" property="og:image" content="/cornichon/img/poster.png" /><meta name="og:title" content="Cornichon: PBT" /><meta name="title" property="og:title" content="Cornichon: PBT" /><meta name="og:site_name" content="Cornichon" /><meta name="og:url" content="http://agourlay.github.io/cornichon/" /><meta name="og:type" content="website" /><meta name="og:description" content="An extensible Scala DSL for testing JSON HTTP APIs." /><link rel="icon" type="image/png" href="/cornichon/img/favicon.png" /><meta name="twitter:title" content="Cornichon: PBT" /><meta name="twitter:image" content="/cornichon/img/poster.png" /><meta name="twitter:description" content="An extensible Scala DSL for testing JSON HTTP APIs." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/cornichon/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cornichon/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cornichon/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cornichon/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cornichon/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cornichon/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cornichon/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cornichon/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cornichon/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cornichon/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cornichon/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cornichon/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cornichon/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cornichon/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cornichon/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cornichon/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cornichon/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cornichon/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cornichon/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cornichon/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cornichon/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cornichon/css/pattern-style.css" /><link rel="stylesheet" href="/cornichon/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/cornichon/" class="brand"><div class="brand-wrapper"><span>Cornichon</span></div></a></li> <li><a href="/cornichon/installation.html" class="">Installation</a></li> <li><a href="/cornichon/basics.html" class="">Basics</a></li> <li><a href="/cornichon/dsl.html" class="">DSL</a></li> <li><a href="/cornichon/custom-steps.html" class="">Custom steps</a> <ul class="sub-section"> <li><a href="/cornichon/custom-steps/effect-step.html" class="">Effect step</a></li> <li><a href="/cornichon/custom-steps/assert-step.html" class="">Assert step</a></li> <li><a href="/cornichon/custom-steps/resource-step.html" class="">Resource step</a></li></ul></li> <li><a href="/cornichon/placeholders.html" class="">Placeholders</a></li> <li><a href="/cornichon/json-matchers.html" class="">JSON matchers</a></li> <li><a href="/cornichon/feature-options.html" class="">Feature options</a></li> <li><a href="/cornichon/reference-configuration.html" class="">Reference configuration</a></li> <li><a href="/cornichon/property-based-testing.html" class="">Property based testing</a></li> <li><a href="/cornichon/misc.html" class="">Misc.</a></li> <li><a href="/cornichon/modules.html" class="">Modules</a> <ul class="sub-section"> <li><a href="/cornichon/modules/module-mock.html" class="">HTTP mock</a></li> <li><a href="/cornichon/modules/module-kafka.html" class="">Kafka integration</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/agourlay/cornichon" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/agourlay/cornichon" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Cornichon An extensible Scala DSL for testing JSON HTTP APIs.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Cornichon An extensible Scala DSL for testing JSON HTTP APIs.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="agourlay" data-github-repo="cornichon"><div class="content-wrapper"><section><h1 id="property-based-testing-support">Property based testing support</h1>

<p>At the center of property based testing lies the capacity to generate arbitrary values that will be used to verify if a given invariant holds.</p>

<h2 id="generators">Generators</h2>

<p>A <code class="highlighter-rouge">generator</code> is simply a function that accepts a <code class="highlighter-rouge">RandomContext</code> which is propagated throughout the execution, for instance below is an example generating Strings and Ints.</p>

<p>There are tree concrete instances of <code class="highlighter-rouge">generators</code>:</p>
<ul>
  <li><code class="highlighter-rouge">ValueGenerator</code></li>
  <li><code class="highlighter-rouge">SessionValueGenerator</code> which provides additionally the <code class="highlighter-rouge">Session</code></li>
  <li><code class="highlighter-rouge">OptionalValueGenerator</code> to fail in a controlled fashion</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">stringGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">ValueGenerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ValueGenerator</span><span class="o">(</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">"an alphanumeric String (20)"</span><span class="o">,</span>
  <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">⇒</span> <span class="nv">rc</span><span class="o">.</span><span class="py">alphanumeric</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span>

<span class="k">def</span> <span class="nf">integerGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">ValueGenerator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ValueGenerator</span><span class="o">(</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">"integer"</span><span class="o">,</span>
  <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">⇒</span> <span class="nv">rc</span><span class="o">.</span><span class="py">nextInt</span><span class="o">(</span><span class="mi">10000</span><span class="o">))</span>
</code></pre></div></div>

<p>This approach also supports embedding <code class="highlighter-rouge">Scalacheck's Gen</code> into a <code class="highlighter-rouge">Generator</code> by propagating the initial seed.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.scalacheck.Gen</span>
<span class="k">import</span> <span class="nn">org.scalacheck.rng.Seed</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Coin</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Head</span> <span class="k">extends</span> <span class="nc">Coin</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Tail</span> <span class="k">extends</span> <span class="nc">Coin</span>

<span class="k">def</span> <span class="nf">coinGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Generator</span><span class="o">[</span><span class="kt">Coin</span><span class="o">]</span> <span class="k">=</span> <span class="nc">OptionalValueGenerator</span><span class="o">(</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">"a Coin"</span><span class="o">,</span>
  <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">⇒</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">nextSeed</span> <span class="k">=</span> <span class="nv">rc</span><span class="o">.</span><span class="py">nextLong</span><span class="o">()</span>
    <span class="k">val</span> <span class="nv">params</span> <span class="k">=</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">Parameters</span><span class="o">.</span><span class="py">default</span><span class="o">.</span><span class="py">withInitialSeed</span><span class="o">(</span><span class="n">nextSeed</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">coin</span> <span class="k">=</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">oneOf</span><span class="o">[</span><span class="kt">Coin</span><span class="o">](</span><span class="nc">Head</span><span class="o">,</span> <span class="nc">Tail</span><span class="o">)</span>
    <span class="nf">coin</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="nc">Seed</span><span class="o">(</span><span class="n">nextSeed</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">)</span>
</code></pre></div></div>

<h2 id="first-flavour---">First flavour - ∀</h2>

<p>The first flavour follows the classical approach found in many testing libraries. That is, for any values from a set of generators, we will validate that a given invariant holds.</p>

<p>Here is the <code class="highlighter-rouge">API</code> available when using a single <code class="highlighter-rouge">generator</code></p>

<p><code class="highlighter-rouge">def for_all[A](description: String, ga: RandomContext ⇒ Generator[A])(f: A ⇒ Step): Step</code></p>

<p>Let’s look at an example to see how to use it!</p>

<p>We want to enforce the following invariant <code class="highlighter-rouge">for any string, if we reverse it twice, it should yield the same value</code>.</p>

<p>The implementation under test is a server accepting <code class="highlighter-rouge">POST</code> requests to <code class="highlighter-rouge">/double-reverse</code> with a query param named <code class="highlighter-rouge">word</code> will return the given <code class="highlighter-rouge">word</code> reversed twice.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.agourlay.cornichon.core._</span>
<span class="k">import</span> <span class="nn">com.github.agourlay.cornichon.CornichonFeature</span>

<span class="k">class</span> <span class="nc">StringReverseCheck</span> <span class="k">extends</span> <span class="nc">CornichonFeature</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">feature</span> <span class="k">=</span> <span class="nc">Feature</span><span class="o">(</span><span class="s">"Basic examples of checks"</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Scenario</span><span class="o">(</span><span class="s">"reverse a string twice yields the same results"</span><span class="o">)</span> <span class="o">{</span>

      <span class="nc">Given</span> <span class="n">check</span> <span class="nf">for_all</span><span class="o">(</span><span class="s">"reversing twice a string yields the same result"</span><span class="o">,</span> <span class="n">maxNumberOfRuns</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">stringGen</span><span class="o">)</span> <span class="o">{</span> <span class="n">randomString</span> <span class="k">=&gt;</span>
        <span class="nc">Attach</span> <span class="o">{</span>
          <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/double-reverse"</span><span class="o">).</span><span class="py">withParams</span><span class="o">(</span><span class="s">"word"</span> <span class="o">-&gt;</span> <span class="n">randomString</span><span class="o">)</span>
          <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
          <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="n">randomString</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">stringGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">ValueGenerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ValueGenerator</span><span class="o">(</span>
    <span class="n">name</span> <span class="k">=</span> <span class="s">"alphanumeric String (20)"</span><span class="o">,</span>
    <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nv">rc</span><span class="o">.</span><span class="py">alphanumeric</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span>
  <span class="o">}</span>

</code></pre></div></div>

<p>To understand what is going on, we can have a look at the logs produced by this scenario.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting scenario 'reverse a string twice yields the same results'
- reverse a string twice yields the same results (1848 millis)

   Scenario : reverse a string twice yields the same results
      main steps
      ForAll 'alphanumeric String (20)' check 'reversing twice a string yields the same result' with maxNumberOfRuns=5 and seed=1542985803071
         Run #0
            Given I POST /double-reverse with query parameters 'word' -&gt; 'vtKxhkCJaVlAOzhdSCwD' (1257 millis)
            Then assert status is '200' (7 millis)
            Then assert response body is vtKxhkCJaVlAOzhdSCwD (32 millis)
         Run #0
         Run #1
            Given I POST /double-reverse with query parameters 'word' -&gt; '1bmmb2urTfJy59J2gGtI' (5 millis)
            Then assert status is '200' (0 millis)
            Then assert response body is 1bmmb2urTfJy59J2gGtI (0 millis)
         Run #1
         Run #2
            Given I POST /double-reverse with query parameters 'word' -&gt; 'Fg3Dzp61as7Pkvvj49ub' (5 millis)
            Then assert status is '200' (0 millis)
            Then assert response body is Fg3Dzp61as7Pkvvj49ub (0 millis)
         Run #2
         Run #3
            Given I POST /double-reverse with query parameters 'word' -&gt; 'bDLbxzMjMgVUP1iRLu4c' (5 millis)
            Then assert status is '200' (0 millis)
            Then assert response body is bDLbxzMjMgVUP1iRLu4c (0 millis)
         Run #3
         Run #4
            Given I POST /double-reverse with query parameters 'word' -&gt; 'byV6Azexsl1AcdatquSJ' (5 millis)
            Then assert status is '200' (0 millis)
            Then assert response body is byV6Azexsl1AcdatquSJ (0 millis)
         Run #4
         Run #5
            Given I POST /double-reverse with query parameters 'word' -&gt; 'pKGqRrbjUV7oMaPJzTJS' (4 millis)
            Then assert status is '200' (0 millis)
            Then assert response body is pKGqRrbjUV7oMaPJzTJS (0 millis)
         Run #5
      ForAll 'alphanumeric String (20)' check 'reversing twice a string yields the same result' block succeeded (1846 millis)
</code></pre></div></div>

<p>The logs show that:</p>

<ul>
  <li>the string generator has been called for each run</li>
  <li>no invariants have been broken</li>
</ul>

<p>The source for the test and the server are available <a href="https://github.com/agourlay/cornichon/tree/master/cornichon-test-framework/src/test/scala/com/github/agourlay/cornichon/framework/examples/propertyCheck/stringReverse">here</a>.</p>

<p>More often than not, using <code class="highlighter-rouge">forAll</code> is enough to cover the most common use cases. But sometimes we not only want to have random values generated but also random interactions with the system under tests.</p>

<h2 id="second-flavour---random-model-exploration">Second flavour - Random model exploration</h2>

<p>The initial inspiration came after reading the following article <a href="https://functional.works-hub.com/learn/property-based-integration-testing-using-haskell-6c25c">Property based integration testing using Haskell!</a> which describes a way to tackle the problem of property based testing for HTTP APIs.</p>

<p>It is still a great introduction to the problem we are trying to solve, although the implementations are significantly different.</p>

<h3 id="concepts">Concepts</h3>

<p>Performing property based testing of a pure function is quite easy, for <code class="highlighter-rouge">all</code> possible values, check that a given invariant is valid.</p>

<p>In the case of an HTTP API, it is more difficult to perform such operations, you are more often than not testing that a set of invariants are valid throughout a workflow.</p>

<p>The key idea is to describe the possible interactions with the API as <a href="https://en.wikipedia.org/wiki/Markov_chain">Markov chains</a> which can be automatically explored.</p>

<p>The entry point for random model exploration is the following function in the DSL:</p>

<p><code class="highlighter-rouge">def check_model[A, B, C, D, E, F](maxNumberOfRuns: Int, maxNumberOfTransitions: Int)(modelRunner: ModelRunner[A, B, C, D, E, F])</code></p>

<p>Let’s unpack this signature:</p>

<ul>
  <li><code class="highlighter-rouge">maxNumberOfRuns</code> refers to maximum number of attempt to traverse the Markov chain and find a case that breaks an invariant</li>
  <li><code class="highlighter-rouge">maxNumberOfTransition</code> is useful when the <code class="highlighter-rouge">model</code> contains cycles in order to ensure termination</li>
  <li><code class="highlighter-rouge">modelRunner</code> is the actual definition of the <code class="highlighter-rouge">model</code></li>
  <li><code class="highlighter-rouge">A B C D E F</code> refers to the types of the <code class="highlighter-rouge">generators</code> used in <code class="highlighter-rouge">model</code> definition (maximum of 6 for the moment)</li>
</ul>

<p>Such a Markov chain wires together a set of <code class="highlighter-rouge">properties</code> that relate to each other through <code class="highlighter-rouge">transitions</code> which are chosen according to a given <code class="highlighter-rouge">probability</code> (between 0 and 100).</p>

<p>A <code class="highlighter-rouge">property</code> is composed of:</p>
<ul>
  <li>a description</li>
  <li>an optional <code class="highlighter-rouge">pre-condition</code> which is a <code class="highlighter-rouge">step</code> checking that the <code class="highlighter-rouge">property</code> can be run (sometimes useful to target error cases)</li>
  <li>an <code class="highlighter-rouge">invariant</code> which is a function from a number of <code class="highlighter-rouge">generators</code> to a <code class="highlighter-rouge">step</code> performing whatever side effect and assertions necessary</li>
</ul>

<p>The number of generators is defined in the <code class="highlighter-rouge">property</code> type:</p>
<ul>
  <li><code class="highlighter-rouge">Property0</code> an action which accepts a function from <code class="highlighter-rouge">() =&gt; Step</code></li>
  <li><code class="highlighter-rouge">Property1[A]</code> an action which accepts a function from <code class="highlighter-rouge">() ⇒ A =&gt; Step</code></li>
  <li><code class="highlighter-rouge">Property2[A, B]</code> an action which accepts a function from <code class="highlighter-rouge">(() ⇒ A, () =&gt; B) =&gt; Step</code></li>
  <li><code class="highlighter-rouge">Property3[A, B, C]</code> an action which accepts a function from <code class="highlighter-rouge">(() ⇒ A, () =&gt; B, () =&gt; C) =&gt; Step</code></li>
  <li>up to <code class="highlighter-rouge">Property6[A, B, C, D, E, F]</code></li>
</ul>

<p>It is of course not required to call a generator when building a <code class="highlighter-rouge">Step</code>.</p>

<p><em>However it is required to have the same <code class="highlighter-rouge">Property</code> type for all properties within a <code class="highlighter-rouge">model</code> definition.</em></p>

<p>Having <code class="highlighter-rouge">generators</code> as input enables the <code class="highlighter-rouge">action</code> to introduce some randomness in its effect.</p>

<p>A <code class="highlighter-rouge">run</code> terminates successfully if the max number of transition reached, this means we were not able to break any invariants.</p>

<p>A <code class="highlighter-rouge">run</code> fails if one of the following conditions is met:</p>
<ul>
  <li>an error is thrown from a <code class="highlighter-rouge">property</code></li>
  <li>no <code class="highlighter-rouge">properties</code> with a valid <code class="highlighter-rouge">pre-condition</code> can be found, this is generally a sign of a malformed <code class="highlighter-rouge">model</code></li>
  <li>a <code class="highlighter-rouge">generator</code> throws an error</li>
</ul>

<p>A <code class="highlighter-rouge">model</code> exploration terminates successfully if the max number of runs is reached or with an error if a run fails.</p>

<p>Let’s create our first <code class="highlighter-rouge">model</code>!</p>

<p>It will be a basic chain which will not enforce any invariants; it will have:</p>

<ul>
  <li>an entry point</li>
  <li>a ping <code class="highlighter-rouge">property</code> printing a random String</li>
  <li>a pong <code class="highlighter-rouge">property</code> printing a random Int</li>
  <li>an exit point</li>
</ul>

<p>We will define the transitions such that:</p>

<ul>
  <li>there is a 50% chance to start with ping or pong following the entry point</li>
  <li>there is 90% to go from a ping/pong to a pong/ping</li>
  <li>there is no loop from any <code class="highlighter-rouge">property</code></li>
  <li>there is a 10% chance to exit the game after a ping or a pong</li>
</ul>

<p>Also the DSL is asking for a <code class="highlighter-rouge">modelRunner</code> which is a little helper connecting a <code class="highlighter-rouge">model</code> to its <code class="highlighter-rouge">generators</code>.</p>

<p>The type inference is sometimes not properly detecting the action type, so it is recommended to define the <code class="highlighter-rouge">modelRunner</code> and the <code class="highlighter-rouge">model</code> as a single expression to help the typechecker.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">stringGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">ValueGenerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ValueGenerator</span><span class="o">(</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">"an alphanumeric String"</span><span class="o">,</span>
  <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">⇒</span> <span class="nv">rc</span><span class="o">.</span><span class="py">alphanumeric</span><span class="o">.</span><span class="py">take</span><span class="o">(</span><span class="mi">20</span><span class="o">).</span><span class="py">mkString</span><span class="o">(</span><span class="s">""</span><span class="o">))</span>

<span class="k">def</span> <span class="nf">integerGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">ValueGenerator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ValueGenerator</span><span class="o">(</span>
  <span class="n">name</span> <span class="k">=</span> <span class="s">"integer"</span><span class="o">,</span>
  <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">⇒</span> <span class="nv">rc</span><span class="o">.</span><span class="py">nextInt</span><span class="o">(</span><span class="mi">10000</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">myModelRunner</span> <span class="k">=</span> <span class="nv">ModelRunner</span><span class="o">.</span><span class="py">make</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">](</span><span class="n">stringGen</span><span class="o">,</span> <span class="n">integerGen</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">val</span> <span class="nv">entryPoint</span> <span class="k">=</span> <span class="nc">Property2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"Entry point"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">⇒</span> <span class="nf">print_step</span><span class="o">(</span><span class="s">"Start game"</span><span class="o">)</span>
  <span class="o">)</span>

  <span class="k">val</span> <span class="nv">pingString</span> <span class="k">=</span> <span class="nc">Property2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"Ping String"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">(</span><span class="n">stringGen</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">⇒</span> <span class="nf">print_step</span><span class="o">(</span><span class="n">s</span><span class="s">"Ping ${stringGen()}"</span><span class="o">)</span>
  <span class="o">)</span>

  <span class="k">val</span> <span class="nv">pongInt</span> <span class="k">=</span> <span class="nc">Property2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"Pong Int"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">intGen</span><span class="o">)</span> <span class="k">⇒</span> <span class="nf">print_step</span><span class="o">(</span><span class="n">s</span><span class="s">"Pong ${intGen()}"</span><span class="o">)</span>
  <span class="o">)</span>

  <span class="k">val</span> <span class="nv">exitPoint</span> <span class="k">=</span> <span class="nc">Property2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"Exit point"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">⇒</span> <span class="nf">print_step</span><span class="o">(</span><span class="s">"End of game"</span><span class="o">)</span>
  <span class="o">)</span>

  <span class="nc">Model</span><span class="o">(</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"ping pong model"</span><span class="o">,</span>
    <span class="n">entryPoint</span> <span class="k">=</span> <span class="n">entryPoint</span><span class="o">,</span>
    <span class="n">transitions</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span>
      <span class="n">entryPoint</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">50</span><span class="o">,</span> <span class="n">pingString</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">50</span><span class="o">,</span> <span class="n">pongInt</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
      <span class="n">pingString</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">90</span><span class="o">,</span> <span class="n">pongInt</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">exitPoint</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
      <span class="n">pongInt</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">90</span><span class="o">,</span> <span class="n">pingString</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">exitPoint</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Which gives us the following scenario</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nc">Scenario</span><span class="o">(</span><span class="err">"</span><span class="n">ping</span> <span class="n">pong</span> <span class="n">check</span><span class="o">)</span> <span class="o">{</span>

  <span class="nc">Given</span> <span class="n">I</span> <span class="nf">check_model</span><span class="o">(</span><span class="n">maxNumberOfRuns</span> <span class="k">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">maxNumberOfTransitions</span> <span class="k">=</span> <span class="mi">10</span><span class="o">)(</span><span class="n">myModelRunner</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Running this scenario outputs:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting scenario 'ping pong check'
- ping pong check (10 millis)

   Scenario : ping pong check
      main steps
      Checking model 'ping pong model' with maxNumberOfRuns=2 and maxNumberOfTransitions=10 and seed=1542986106586
         Run #1
            Entry point
            Start game
            Ping String
            Ping 7HjRBzlyjULWQlV1SQeN
            Pong Int
            Pong 3549
            Ping String
            Ping SbL4blEMtwweAqm9bfP0
            Pong Int
            Pong 1464
            Ping String
            Ping BoZwLouAaXVayxXajSXV
            Pong Int
            Pong 161
            Ping String
            Ping BOCm8OyLL2zgpPCoYnTJ
            Pong Int
            Pong 687
            Ping String
            Ping d9ZRN1HuBhVwFKXBzlUh
            Pong Int
            Pong 1892
         Run #1 - Max transitions number per run reached
         Run #2
            Entry point
            Start game
            Ping String
            Ping oHARiIS8570hOHbkpu6b
            Pong Int
            Pong 743
            Ping String
            Ping Ijq1xltbS2fGIVJ0h3ty
            Pong Int
            Pong 7575
            Ping String
            Ping 15DDNEIATOrbKnDQi9QI
            Pong Int
            Pong 4674
            Ping String
            Ping YNvchmkwK7owS95YeyXr
            Pong Int
            Pong 3758
            Ping String
            Ping DavIeJhxwOpgmqXZrzOU
            Exit point
            End of game
         Run #2 - End reached on property 'Exit point' after 10 transitions
      Check block succeeded (10 millis)

</code></pre></div></div>

<p>The logs give us:</p>
<ul>
  <li>a detailed description of the runs execution</li>
  <li>the seed used to create the <code class="highlighter-rouge">Generators</code></li>
</ul>

<p>It is possible to replay exactly the same run by passing the seed as a parameter of the feature or by a CLI argument.</p>

<h3 id="examples">Examples</h3>

<p>Now that we have a better understanding of the concepts and their semantics, it is time to dive into some concrete examples!</p>

<p>Having <code class="highlighter-rouge">cornichon</code> freely explore the <code class="highlighter-rouge">transitions</code> of a <code class="highlighter-rouge">model</code> can create some interesting configurations.</p>

<h4 id="turnstile">Turnstile</h4>

<p>In this example we are going to test an HTTP API implementing a basic turnstile.</p>

<p>This is a rotating gate that let people pass one at the time after payment. In our simplified model it is not possible to pay for several people to pass in advance.</p>

<p>The server exposes two endpoints:</p>
<ul>
  <li>a <code class="highlighter-rouge">POST</code> request on <code class="highlighter-rouge">/push-coin</code> to unlock the gate</li>
  <li>a <code class="highlighter-rouge">POST</code> request on <code class="highlighter-rouge">/walk-through</code> to turn the gate</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.agourlay.cornichon.CornichonFeature</span>
<span class="k">import</span> <span class="nn">com.github.agourlay.cornichon.steps.check.checkModel._</span>

<span class="k">class</span> <span class="nc">TurnstileCheck</span> <span class="k">extends</span> <span class="nc">CornichonFeature</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">feature</span> <span class="k">=</span> <span class="nc">Feature</span><span class="o">(</span><span class="s">"Basic examples of checks"</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Scenario</span><span class="o">(</span><span class="s">"Turnstile acts according to model"</span><span class="o">)</span> <span class="o">{</span>

      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">check_model</span><span class="o">(</span><span class="n">maxNumberOfRuns</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">maxNumberOfTransitions</span> <span class="k">=</span> <span class="mi">10</span><span class="o">)(</span><span class="n">turnstileModel</span><span class="o">)</span>

    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">//Model definition usually in another trait</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">pushCoin</span> <span class="k">=</span> <span class="nc">Property0</span><span class="o">(</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"push a coin"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/push-coin"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
      <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="s">"payment accepted"</span><span class="o">)</span>
    <span class="o">})</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">pushCoinBlocked</span> <span class="k">=</span> <span class="nc">Property0</span><span class="o">(</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"push a coin is a blocked"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/push-coin"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">400</span><span class="o">)</span>
      <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="s">"payment refused"</span><span class="o">)</span>
    <span class="o">})</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">walkThroughOk</span> <span class="k">=</span> <span class="nc">Property0</span><span class="o">(</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"walk through ok"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/walk-through"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
      <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="s">"door turns"</span><span class="o">)</span>
    <span class="o">})</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">walkThroughBlocked</span> <span class="k">=</span> <span class="nc">Property0</span><span class="o">(</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"walk through blocked"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/walk-through"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">400</span><span class="o">)</span>
      <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="s">"door blocked"</span><span class="o">)</span>
    <span class="o">})</span>

  <span class="k">val</span> <span class="nv">turnstileModel</span> <span class="k">=</span> <span class="nv">ModelRunner</span><span class="o">.</span><span class="py">makeNoGen</span><span class="o">(</span>
    <span class="nc">Model</span><span class="o">(</span>
      <span class="n">description</span> <span class="k">=</span> <span class="s">"Turnstile acts according to model"</span><span class="o">,</span>
      <span class="n">entryPoint</span> <span class="k">=</span> <span class="n">pushCoin</span><span class="o">,</span>
      <span class="n">transitions</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span>
        <span class="n">pushCoin</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">90</span><span class="o">,</span> <span class="n">walkThroughOk</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">pushCoinBlocked</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
        <span class="n">pushCoinBlocked</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">90</span><span class="o">,</span> <span class="n">walkThroughOk</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">pushCoinBlocked</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
        <span class="n">walkThroughOk</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">70</span><span class="o">,</span> <span class="n">pushCoin</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="n">walkThroughBlocked</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
        <span class="n">walkThroughBlocked</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">90</span><span class="o">,</span> <span class="n">pushCoin</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">walkThroughBlocked</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Again let’s have a look at the logs to see how things go.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting scenario 'Turnstile acts according to model'
- Turnstile acts according to model (55 millis)

   Scenario : Turnstile acts according to model
      main steps
      Checking model 'Turnstile acts according to model' with maxNumberOfRuns=1 and maxNumberOfTransitions=10 and seed=1542021399582
         Run #1
            push a coin
            Given I POST /push-coin (9 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            push a coin is a blocked
            Given I POST /push-coin (5 millis)
            Then assert status is '400' (0 millis)
            And assert response body is payment refused (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            walk through blocked
            Given I POST /walk-through (3 millis)
            Then assert status is '400' (0 millis)
            And assert response body is door blocked (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
         Run #1 - Max transitions number per run reached
      Check block succeeded (54 millis)
</code></pre></div></div>

<p>It is interesting to note that we are executing a single run on purpose, as the server is stateful, any subsequent runs would share the global state of the turnstile.</p>

<p>This is an issue because we are starting our model with <code class="highlighter-rouge">pushCoinAction</code> which is always expected to succeed.</p>

<p>Let’s try to test the same model with more runs to see if it breaks!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting scenario 'Turnstile acts according to model'
- **failed** Turnstile acts according to model (74 millis)

  Scenario 'Turnstile acts according to model' failed:

  at step:
  Then assert status is '200'

  with error(s):
  expected status code '200' but '400' was received with body:
  "payment refused"
  and with headers:
  'Date' -&gt; 'Mon, 12 Nov 2018 11:18:03 GMT'

  replay only this scenario with the command:
  testOnly *TurnstileCheck -- "Turnstile acts according to model"

   Scenario : Turnstile acts according to model
      main steps
      Checking model 'Turnstile acts according to model' with maxNumberOfRuns=2 and maxNumberOfTransitions=10 and seed=1542021482941
         Run #1
            push a coin
            Given I POST /push-coin (11 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (4 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (4 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
            walk through ok
            Given I POST /walk-through (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is door turns (0 millis)
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' (0 millis)
            And assert response body is payment accepted (0 millis)
         Run #1 - Max transitions number per run reached
         Run #2
            push a coin
            Given I POST /push-coin (3 millis)
            Then assert status is '200' *** FAILED ***
            expected status code '200' but '400' was received with body:
            "payment refused"
            and with headers:
            'Date' -&gt; 'Mon, 12 Nov 2018 11:18:03 GMT'
         Run #2 - Failed
      Check model block failed  (74 millis)
</code></pre></div></div>

<p>Using 2 runs, we already found the problem because the first run finished by introducing a coin.</p>

<p>It is possible to replay exactly this run in a deterministic fashion by using the <code class="highlighter-rouge">seed</code> printed in the logs and feed it to the DSL.</p>

<p><code class="highlighter-rouge">Given I check_model(maxNumberOfRuns = 2, maxNumberOfTransitions = 10)(turnstileModel)</code></p>

<p>This example shows that designing property based scenarios is sometimes challenging in the case of shared mutable states.</p>

<p>The source for the test and the server are available <a href="https://github.com/agourlay/cornichon/tree/master/cornichon-test-framework/src/test/scala/com/github/agourlay/cornichon/framework/examples/propertyCheck/turnstile">here</a>.</p>

<h4 id="web-shop-admin-advanced-example">Web shop Admin (advanced example)</h4>

<p>In this example we are going to test an HTTP API implementing a basic web shop.</p>

<p>This web shop offers the possibility to <code class="highlighter-rouge">CRUD</code> products and to search them via an index that is eventually consistent.</p>

<p>A product is defined by the following case class.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Product</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">price</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ProductDraft</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">price</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">)</span>
</code></pre></div></div>

<p>The server exposes the following endpoint:</p>
<ul>
  <li>a <code class="highlighter-rouge">POST</code> request on <code class="highlighter-rouge">/products</code> to create a product via productDraft</li>
  <li>a <code class="highlighter-rouge">POST</code> request on <code class="highlighter-rouge">/products/&lt;id&gt;</code> to update a product</li>
  <li>a <code class="highlighter-rouge">DELETE</code> request on <code class="highlighter-rouge">/products/&lt;id&gt;</code> to delete a product</li>
  <li>a <code class="highlighter-rouge">GET</code> request on <code class="highlighter-rouge">/products</code> to get all products</li>
  <li>a <code class="highlighter-rouge">GET</code> request on <code class="highlighter-rouge">/products/&lt;id&gt;</code> to get a single product</li>
  <li>a <code class="highlighter-rouge">GET</code> request on <code class="highlighter-rouge">products-search</code> to get all the products in the search index</li>
</ul>

<p>The contract is that the consistency delay should always be under 10 seconds for all operations being mirrored in the search index.</p>

<p>Let’s see if we can test it!</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">com.github.agourlay.cornichon.check.examples.webShop</span>


<span class="k">class</span> <span class="nc">WebShopCheck</span> <span class="k">extends</span> <span class="nc">CornichonFeature</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">feature</span> <span class="k">=</span> <span class="nc">Feature</span><span class="o">(</span><span class="s">"Advanced example of model checks"</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Scenario</span><span class="o">(</span><span class="s">"WebShop acts according to model"</span><span class="o">)</span> <span class="o">{</span>

      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">check_model</span><span class="o">(</span><span class="n">maxNumberOfRuns</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">maxNumberOfTransitions</span> <span class="k">=</span> <span class="mi">5</span><span class="o">)(</span><span class="n">webShopModel</span><span class="o">)</span>

    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="nv">maxIndexSyncTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span>

  <span class="k">def</span> <span class="nf">productDraftGen</span><span class="o">(</span><span class="n">rc</span><span class="k">:</span> <span class="kt">RandomContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Generator</span><span class="o">[</span><span class="kt">ProductDraft</span><span class="o">]</span> <span class="k">=</span> <span class="nc">OptionalValueGenerator</span><span class="o">(</span>
    <span class="n">name</span> <span class="k">=</span> <span class="s">"a product draft"</span><span class="o">,</span>
    <span class="n">gen</span> <span class="k">=</span> <span class="o">()</span> <span class="k">⇒</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">nextSeed</span> <span class="k">=</span> <span class="nv">rc</span><span class="o">.</span><span class="py">nextLong</span><span class="o">()</span>
      <span class="k">val</span> <span class="nv">params</span> <span class="k">=</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">Parameters</span><span class="o">.</span><span class="py">default</span><span class="o">.</span><span class="py">withInitialSeed</span><span class="o">(</span><span class="n">nextSeed</span><span class="o">)</span>
      <span class="k">val</span> <span class="nv">gen</span> <span class="k">=</span>
        <span class="k">for</span> <span class="o">{</span>
          <span class="n">name</span> <span class="k">←</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">alphaStr</span>
          <span class="n">description</span> <span class="k">←</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">alphaStr</span>
          <span class="n">price</span> <span class="k">←</span> <span class="nv">Gen</span><span class="o">.</span><span class="py">choose</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MaxValue</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">yield</span> <span class="nc">ProductDraft</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">description</span><span class="o">,</span> <span class="n">price</span><span class="o">)</span>
      <span class="nf">gen</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="nc">Seed</span><span class="o">(</span><span class="n">nextSeed</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">)</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">noProductsInDb</span> <span class="k">=</span> <span class="nc">Property1</span><span class="o">[</span><span class="kt">ProductDraft</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"no products in DB"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="k">_</span> <span class="k">⇒</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">asArray</span><span class="o">.</span><span class="py">isEmpty</span>
    <span class="o">}</span>
  <span class="o">)</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">createProduct</span> <span class="k">=</span> <span class="nc">Property1</span><span class="o">[</span><span class="kt">ProductDraft</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"create a product"</span><span class="o">,</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="n">pd</span> <span class="k">⇒</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">productDraft</span> <span class="k">=</span> <span class="nf">pd</span><span class="o">()</span>
      <span class="k">val</span> <span class="nv">productDraftJson</span> <span class="k">=</span> <span class="nv">productDraft</span><span class="o">.</span><span class="py">asJson</span>
      <span class="nc">Attach</span> <span class="o">{</span>
        <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/products"</span><span class="o">).</span><span class="py">withBody</span><span class="o">(</span><span class="n">productDraftJson</span><span class="o">)</span>
        <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">201</span><span class="o">)</span>
        <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">ignoring</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="py">is</span><span class="o">(</span><span class="n">productDraftJson</span><span class="o">)</span>
        <span class="nc">Eventually</span><span class="o">(</span><span class="n">maxDuration</span> <span class="k">=</span> <span class="n">maxIndexSyncTimeout</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">millis</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">When</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products-search"</span><span class="o">)</span>
          <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
          <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">asArray</span><span class="o">.</span><span class="py">ignoringEach</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="py">contains</span><span class="o">(</span><span class="n">productDraftJson</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">})</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">deleteProduct</span> <span class="k">=</span> <span class="nc">Property1</span><span class="o">[</span><span class="kt">ProductDraft</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"delete a product"</span><span class="o">,</span>
    <span class="n">preCondition</span> <span class="k">=</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">asArray</span><span class="o">.</span><span class="py">isNotEmpty</span>
    <span class="o">},</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="k">_</span> <span class="k">⇒</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">I</span> <span class="nf">save_body_path</span><span class="o">(</span><span class="s">"$[0].id"</span> <span class="o">-&gt;</span> <span class="s">"id-to-delete"</span><span class="o">)</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">delete</span><span class="o">(</span><span class="s">"/products/&lt;id-to-delete&gt;"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
      <span class="nc">And</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products/&lt;id-to-delete&gt;"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">404</span><span class="o">)</span>
      <span class="nc">Eventually</span><span class="o">(</span><span class="n">maxDuration</span> <span class="k">=</span> <span class="n">maxIndexSyncTimeout</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">millis</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">When</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products-search"</span><span class="o">)</span>
        <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
        <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">path</span><span class="o">(</span><span class="s">"$[*].id"</span><span class="o">).</span><span class="py">asArray</span><span class="o">.</span><span class="py">not_contains</span><span class="o">(</span><span class="s">"&lt;id-to-delete&gt;"</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">)</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nv">updateProduct</span> <span class="k">=</span> <span class="nc">Property1</span><span class="o">[</span><span class="kt">ProductDraft</span><span class="o">](</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"update a product"</span><span class="o">,</span>
    <span class="n">preCondition</span> <span class="k">=</span> <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">Given</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">asArray</span><span class="o">.</span><span class="py">isNotEmpty</span>
    <span class="o">},</span>
    <span class="n">invariant</span> <span class="k">=</span> <span class="n">pd</span> <span class="k">⇒</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">productDraft</span> <span class="k">=</span> <span class="nf">pd</span><span class="o">()</span>
      <span class="k">val</span> <span class="nv">productDraftJson</span> <span class="k">=</span> <span class="nv">productDraft</span><span class="o">.</span><span class="py">asJson</span>
      <span class="nc">Attach</span> <span class="o">{</span>
        <span class="nc">Given</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products"</span><span class="o">)</span>
        <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
        <span class="nc">Then</span> <span class="n">I</span> <span class="nf">save_body_path</span><span class="o">(</span><span class="s">"$[0].id"</span> <span class="o">-&gt;</span> <span class="s">"id-to-update"</span><span class="o">)</span>
        <span class="nc">Given</span> <span class="n">I</span> <span class="nf">post</span><span class="o">(</span><span class="s">"/products/&lt;id-to-update&gt;"</span><span class="o">).</span><span class="py">withBody</span><span class="o">(</span><span class="n">productDraftJson</span><span class="o">)</span>
        <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">201</span><span class="o">)</span>
        <span class="nc">And</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products/&lt;id-to-update&gt;"</span><span class="o">)</span>
        <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
        <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">ignoring</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="py">is</span><span class="o">(</span><span class="n">productDraftJson</span><span class="o">)</span>
        <span class="nc">Eventually</span><span class="o">(</span><span class="n">maxDuration</span> <span class="k">=</span> <span class="n">maxIndexSyncTimeout</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">millis</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">When</span> <span class="n">I</span> <span class="nf">get</span><span class="o">(</span><span class="s">"/products-search"</span><span class="o">)</span>
          <span class="nc">Then</span> <span class="n">assert</span> <span class="nv">status</span><span class="o">.</span><span class="py">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
          <span class="nc">And</span> <span class="n">assert</span> <span class="nv">body</span><span class="o">.</span><span class="py">asArray</span><span class="o">.</span><span class="py">ignoringEach</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="py">contains</span><span class="o">(</span><span class="n">productDraftJson</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">)</span>

  <span class="k">val</span> <span class="nv">webShopModel</span> <span class="k">=</span> <span class="nv">ModelRunner</span><span class="o">.</span><span class="py">make</span><span class="o">[</span><span class="kt">ProductDraft</span><span class="o">](</span><span class="n">productDraftGen</span><span class="o">)(</span>
    <span class="nc">Model</span><span class="o">(</span>
      <span class="n">description</span> <span class="k">=</span> <span class="s">"WebShop acts according to specification"</span><span class="o">,</span>
      <span class="n">entryPoint</span> <span class="k">=</span> <span class="n">noProductsInDb</span><span class="o">,</span>
      <span class="n">transitions</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span>
        <span class="n">noProductsInDb</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">100</span><span class="o">,</span> <span class="n">createProduct</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
        <span class="n">createProduct</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">60</span><span class="o">,</span> <span class="n">createProduct</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="n">updateProduct</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">deleteProduct</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
        <span class="n">deleteProduct</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">60</span><span class="o">,</span> <span class="n">createProduct</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="n">updateProduct</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">deleteProduct</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>
        <span class="n">updateProduct</span> <span class="o">-&gt;</span> <span class="o">((</span><span class="mi">60</span><span class="o">,</span> <span class="n">createProduct</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="n">updateProduct</span><span class="o">)</span> <span class="o">::</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">deleteProduct</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Again, let’s have a look at the logs to see how things go.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Advanced example of model checks:
Starting scenario 'WebShop acts according to model'
- WebShop acts according to model (42747 millis)

   Scenario : WebShop acts according to model
      main steps
      Checking model 'WebShop acts according to specification' with maxNumberOfRuns=1 and maxNumberOfTransitions=5 and seed=1544540492543
         Run #1
            no products in DB
            Given I GET /products (1328 millis)
            Then assert status is '200' (10 millis)
            Then assert response body array size is '0' (15 millis)
            create a product
            Given I POST /products with body (59 millis)
            {
              "name" : "rzdikphaxkjroaoYguPblwnwxdnnnrokkjhscTfmwfanhrsXsamphz",
              "description" : "flaukuIykZksgwsxznkayAiiojwgndtiffT",
              "price" : 32
            }
            Then assert status is '201' (0 millis)
            And assert response body is (41 millis)
            {
              "name" : "rzdikphaxkjroaoYguPblwnwxdnnnrokkjhscTfmwfanhrsXsamphz",
              "description" : "flaukuIykZksgwsxznkayAiiojwgndtiffT",
              "price" : 32
            } ignoring keys id
            Eventually block with maxDuration = 10 seconds and interval = 10 milliseconds
               When I GET /products-search (9 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains
               {
                 "name" : "rzdikphaxkjroaoYguPblwnwxdnnnrokkjhscTfmwfanhrsXsamphz",
                 "description" : "flaukuIykZksgwsxznkayAiiojwgndtiffT",
                 "price" : 32
               } *** FAILED ***
               expected array to contain
               '{
                 "name" : "rzdikphaxkjroaoYguPblwnwxdnnnrokkjhscTfmwfanhrsXsamphz",
                 "description" : "flaukuIykZksgwsxznkayAiiojwgndtiffT",
                 "price" : 32
               }'
               but it is not the case with array:
               [
               ]
               When I GET /products-search (5 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains (0 millis)
               {
                 "name" : "rzdikphaxkjroaoYguPblwnwxdnnnrokkjhscTfmwfanhrsXsamphz",
                 "description" : "flaukuIykZksgwsxznkayAiiojwgndtiffT",
                 "price" : 32
               }
            Eventually block succeeded after '552' retries with '1' distinct errors (8972 millis)
            update a product
            Given I GET /products (2 millis)
            Then assert status is '200' (0 millis)
            Then I save path '$[0].id' from body to key 'id-to-update' (8 millis)
            Given I POST /products/ee668765-b274-462d-ace8-73e2464286ca with body (11 millis)
            {
              "name" : "usogcaoeNkEgmaqybjpoisbtizlFkNyyrvvgCtbwoxdzxijwwdugmJZeksdBFbvcXn",
              "description" : "wflinKgfiguhNjkhwepgsdUmylbrXsjvhEnUccHzqglrpaiksaEtlbgmhfocAWjvieTwva",
              "price" : 46
            }
            Then assert status is '201' (0 millis)
            And I GET /products/ee668765-b274-462d-ace8-73e2464286ca (6 millis)
            Then assert status is '200' (0 millis)
            And assert response body is (0 millis)
            {
              "name" : "usogcaoeNkEgmaqybjpoisbtizlFkNyyrvvgCtbwoxdzxijwwdugmJZeksdBFbvcXn",
              "description" : "wflinKgfiguhNjkhwepgsdUmylbrXsjvhEnUccHzqglrpaiksaEtlbgmhfocAWjvieTwva",
              "price" : 46
            } ignoring keys id
            Eventually block with maxDuration = 10 seconds and interval = 10 milliseconds
               When I GET /products-search (2 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains
               {
                 "name" : "usogcaoeNkEgmaqybjpoisbtizlFkNyyrvvgCtbwoxdzxijwwdugmJZeksdBFbvcXn",
                 "description" : "wflinKgfiguhNjkhwepgsdUmylbrXsjvhEnUccHzqglrpaiksaEtlbgmhfocAWjvieTwva",
                 "price" : 46
               } *** FAILED ***
               expected array to contain
               '{
                 "name" : "usogcaoeNkEgmaqybjpoisbtizlFkNyyrvvgCtbwoxdzxijwwdugmJZeksdBFbvcXn",
                 "description" : "wflinKgfiguhNjkhwepgsdUmylbrXsjvhEnUccHzqglrpaiksaEtlbgmhfocAWjvieTwva",
                 "price" : 46
               }'
               but it is not the case with array:
               [
                 {
                   "id" : "ee668765-b274-462d-ace8-73e2464286ca",
                   "name" : "rzdikphaxkjroaoYguPblwnwxdnnnrokkjhscTfmwfanhrsXsamphz",
                   "description" : "flaukuIykZksgwsxznkayAiiojwgndtiffT",
                   "price" : 32
                 }
               ]
               When I GET /products-search (2 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains (0 millis)
               {
                 "name" : "usogcaoeNkEgmaqybjpoisbtizlFkNyyrvvgCtbwoxdzxijwwdugmJZeksdBFbvcXn",
                 "description" : "wflinKgfiguhNjkhwepgsdUmylbrXsjvhEnUccHzqglrpaiksaEtlbgmhfocAWjvieTwva",
                 "price" : 46
               }
            Eventually block succeeded after '616' retries with '1' distinct errors (8996 millis)
            delete a product
            Given I GET /products (1 millis)
            Then assert status is '200' (0 millis)
            Then I save path '$[0].id' from body to key 'id-to-delete' (0 millis)
            Given I DELETE /products/ee668765-b274-462d-ace8-73e2464286ca (2 millis)
            Then assert status is '200' (0 millis)
            And I GET /products/ee668765-b274-462d-ace8-73e2464286ca (1 millis)
            Then assert status is '404' (0 millis)
            Eventually block with maxDuration = 10 seconds and interval = 10 milliseconds
               When I GET /products-search (1 millis)
               Then assert status is '200' (0 millis)
               And assert response body's array '$[*].id' does not contain
               ee668765-b274-462d-ace8-73e2464286ca *** FAILED ***
               expected array to not contain
               '"ee668765-b274-462d-ace8-73e2464286ca"'
               but it is not the case with array:
               [
                 "ee668765-b274-462d-ace8-73e2464286ca"
               ]
               When I GET /products-search (2 millis)
               Then assert status is '200' (0 millis)
               And assert response body's array '$[*].id' does not contain (0 millis)
               ee668765-b274-462d-ace8-73e2464286ca
            Eventually block succeeded after '571' retries with '1' distinct errors (8001 millis)
            create a product
            Given I POST /products with body (2 millis)
            {
              "name" : "kskqbczgcepmzvoybdKmpniflncdWqbqejtLcj",
              "description" : "krrzzpmbwLyxsfiwxhdlnoycnfk",
              "price" : 77
            }
            Then assert status is '201' (0 millis)
            And assert response body is (0 millis)
            {
              "name" : "kskqbczgcepmzvoybdKmpniflncdWqbqejtLcj",
              "description" : "krrzzpmbwLyxsfiwxhdlnoycnfk",
              "price" : 77
            } ignoring keys id
            Eventually block with maxDuration = 10 seconds and interval = 10 milliseconds
               When I GET /products-search (1 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains
               {
                 "name" : "kskqbczgcepmzvoybdKmpniflncdWqbqejtLcj",
                 "description" : "krrzzpmbwLyxsfiwxhdlnoycnfk",
                 "price" : 77
               } *** FAILED ***
               expected array to contain
               '{
                 "name" : "kskqbczgcepmzvoybdKmpniflncdWqbqejtLcj",
                 "description" : "krrzzpmbwLyxsfiwxhdlnoycnfk",
                 "price" : 77
               }'
               but it is not the case with array:
               [
               ]
               When I GET /products-search (1 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains (0 millis)
               {
                 "name" : "kskqbczgcepmzvoybdKmpniflncdWqbqejtLcj",
                 "description" : "krrzzpmbwLyxsfiwxhdlnoycnfk",
                 "price" : 77
               }
            Eventually block succeeded after '671' retries with '1' distinct errors (9003 millis)
            create a product
            Given I POST /products with body (2 millis)
            {
              "name" : "mrhwfmp",
              "description" : "hBvcqpyatdyjccokfvXtbppejlSfnuGgmahAclfjCqmzCmdqydNsiYlICpZnwgqxzVkzrqnoyucZtbgoguc",
              "price" : 18
            }
            Then assert status is '201' (0 millis)
            And assert response body is (0 millis)
            {
              "name" : "mrhwfmp",
              "description" : "hBvcqpyatdyjccokfvXtbppejlSfnuGgmahAclfjCqmzCmdqydNsiYlICpZnwgqxzVkzrqnoyucZtbgoguc",
              "price" : 18
            } ignoring keys id
            Eventually block with maxDuration = 10 seconds and interval = 10 milliseconds
               When I GET /products-search (0 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains
               {
                 "name" : "mrhwfmp",
                 "description" : "hBvcqpyatdyjccokfvXtbppejlSfnuGgmahAclfjCqmzCmdqydNsiYlICpZnwgqxzVkzrqnoyucZtbgoguc",
                 "price" : 18
               } *** FAILED ***
               expected array to contain
               '{
                 "name" : "mrhwfmp",
                 "description" : "hBvcqpyatdyjccokfvXtbppejlSfnuGgmahAclfjCqmzCmdqydNsiYlICpZnwgqxzVkzrqnoyucZtbgoguc",
                 "price" : 18
               }'
               but it is not the case with array:
               [
                 {
                   "id" : "acd3425c-08cb-4cb0-be11-1d3e4611c1fa",
                   "name" : "kskqbczgcepmzvoybdKmpniflncdWqbqejtLcj",
                   "description" : "krrzzpmbwLyxsfiwxhdlnoycnfk",
                   "price" : 77
                 }
               ]
               When I GET /products-search (1 millis)
               Then assert status is '200' (0 millis)
               And assert response body array contains (0 millis)
               {
                 "name" : "mrhwfmp",
                 "description" : "hBvcqpyatdyjccokfvXtbppejlSfnuGgmahAclfjCqmzCmdqydNsiYlICpZnwgqxzVkzrqnoyucZtbgoguc",
                 "price" : 18
               }
            Eventually block succeeded after '463' retries with '1' distinct errors (6001 millis)
         Run #1 - Max transitions number per run reached
      Check block succeeded (42662 millis)
</code></pre></div></div>

<p>We can see that we have been interacting with the <code class="highlighter-rouge">CRUD</code> API using randomly generated <code class="highlighter-rouge">ProductDraft</code> and that the eventually consistent contracts seem to hold.</p>

<p>The source for the test and the server are available <a href="https://github.com/agourlay/cornichon/tree/master/cornichon-test-framework/src/test/scala/com/github/agourlay/cornichon/framework/examples/propertyCheck/webShop">here</a>.</p>

<h3 id="caveats">Caveats</h3>

<ul>
  <li>all <code class="highlighter-rouge">properties</code> must have the same types within a <code class="highlighter-rouge">model</code> definition</li>
  <li>the API has a few rough edges, especially regarding type inference for the <code class="highlighter-rouge">modelRunner</code> definition</li>
  <li>placeholders generating random data such as <code class="highlighter-rouge">&lt;random-string&gt;</code> and <code class="highlighter-rouge">&lt;random-uuid&gt;</code> are not yet using the correct <code class="highlighter-rouge">seed</code></li>
  <li>the max number of <code class="highlighter-rouge">generators</code> is hard-coded to 6</li>
</ul>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/cornichon/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'agourlay/cornichon'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cornichon/js/main.js"></script></body></html>
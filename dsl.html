<html><head><title>Cornichon</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Arnaud Gourlay" /><meta name="description" content="An extensible Scala DSL for testing JSON HTTP APIs." /><meta name="og:image" content="/cornichon/img/poster.png" /><meta name="og:title" content="Cornichon" /><meta name="og:site_name" content="Cornichon" /><meta name="og:url" content="http://agourlay.github.io/cornichon/" /><meta name="og:type" content="website" /><meta name="og:description" content="An extensible Scala DSL for testing JSON HTTP APIs." /><link rel="icon" type="image/png" href="/cornichon/img/favicon.png" /><meta name="twitter:title" content="Cornichon" /><meta name="twitter:image" content="http://agourlay.github.io/cornichon/img/poster.png" /><meta name="twitter:description" content="An extensible Scala DSL for testing JSON HTTP APIs." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/cornichon/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cornichon/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cornichon/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cornichon/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cornichon/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cornichon/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cornichon/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cornichon/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cornichon/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cornichon/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cornichon/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cornichon/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cornichon/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cornichon/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cornichon/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cornichon/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cornichon/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cornichon/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cornichon/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cornichon/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cornichon/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cornichon/css/style.css" /><link rel="stylesheet" href="/cornichon/css/palette.css" /><link rel="stylesheet" href="/cornichon/css/codemirror.css" /><link rel="stylesheet" href="/cornichon/css/kazari-style.css" /><link rel="stylesheet" href="/cornichon/css/monokai.css" /><link rel="stylesheet" href="/cornichon/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/cornichon/" class="brand"><div class="brand-wrapper"><span>Cornichon</span></div></a></li> <li><a href="/cornichon/dsl.html" class=" active ">DSL</a></li> <li><a href="/cornichon/custom-steps.html" class="">Custom steps</a></li> <li><a href="/cornichon/placeholders-matchers.html" class="">Placeholders & matchers</a></li> <li><a href="/cornichon/feature-options.html" class="">Feature options</a></li> <li><a href="/cornichon/misc.html" class="">Misc.</a></li> <li><a href="/cornichon/modules.html" class="">Modules</a></li> <li><a href="/cornichon/kafka.html" class="">Kafka (Experimental)</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/agourlay/cornichon"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/agourlay/cornichon"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Cornichon An extensible Scala DSL for testing JSON HTTP APIs.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Cornichon An extensible Scala DSL for testing JSON HTTP APIs.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="agourlay" data-github-repo="cornichon"><div class="content-wrapper"><section><h1 id="dsl">DSL</h1>

<p>The content of a <code class="highlighter-rouge">feature</code> is described using a domain-specific language (DSL) providing a clear structure for statement definitions.</p>

<p>The structure of a step statement is the following:</p>

<p>1 - starts with either <code class="highlighter-rouge">Given</code> - <code class="highlighter-rouge">When</code> - <code class="highlighter-rouge">And</code> - <code class="highlighter-rouge">Then</code></p>

<p>The prefixes do not change the behavior of the steps but are present to improve the readability.</p>

<p>2 - followed by any single word (could be several words wrapped in back-ticks)</p>

<p>This structure was chosen to increase the freedom of customization while still benefiting from Scala’s infix notation.</p>

<p>3 - ending with a <code class="highlighter-rouge">step</code> definition</p>

<p>The usage pattern is often to first run a <code class="highlighter-rouge">step</code> with a side effect then assert an expected state in a second <code class="highlighter-rouge">step</code>.</p>

<p>For example :</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Given</span> <span class="n">I</span> <span class="n">step_definition</span>

<span class="nc">When</span> <span class="n">a</span> <span class="n">step_definition</span>

<span class="nc">And</span> <span class="o">\`</span><span class="n">another</span> <span class="n">really</span> <span class="n">important</span><span class="o">\`</span> <span class="n">step_definition</span>

<span class="nc">Then</span> <span class="n">assert</span> <span class="n">step_definition</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">step_definition</code> stands here for any object of type <code class="highlighter-rouge">Step</code>, those can be manually defined or simply built-in in Cornichon.</p>

<h1 id="built-in-steps">Built-in steps</h1>

<p>Cornichon has a set of built-in steps for various HTTP calls and assertions on the response.</p>

<h2 id="http-effects">HTTP effects</h2>

<ul>
  <li>GET, DELETE, HEAD, OPTIONS, POST, PUT and PATCH use the same request builder for request’s body, URL parameters and headers.</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">head</span><span class="o">(</span><span class="s">"http://superhero.io/daredevil"</span><span class="o">)</span>

<span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/daredevil"</span><span class="o">).</span><span class="n">withParams</span><span class="o">(</span>
  <span class="s">"firstParam"</span> <span class="o">→</span> <span class="s">"value1"</span><span class="o">,</span>
  <span class="s">"secondParam"</span> <span class="o">→</span> <span class="s">"value2"</span><span class="o">)</span>

<span class="n">delete</span><span class="o">(</span><span class="s">"http://superhero.io/daredevil"</span><span class="o">).</span><span class="n">withHeaders</span><span class="o">((</span><span class="s">"Authorization"</span><span class="o">,</span> <span class="s">"Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ=="</span><span class="o">))</span>

<span class="n">post</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">).</span><span class="n">withBody</span><span class="o">(</span><span class="s">"JSON description of Batman goes here"</span><span class="o">)</span>

<span class="n">put</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">).</span><span class="n">withBody</span><span class="o">(</span><span class="s">"JSON description of Batman goes here"</span><span class="o">).</span><span class="n">withParams</span><span class="o">(</span>
  <span class="s">"firstParam"</span> <span class="o">→</span> <span class="s">"value1"</span><span class="o">,</span>
  <span class="s">"secondParam"</span> <span class="o">→</span> <span class="s">"value2"</span><span class="o">)</span>

<span class="n">patch</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">).</span><span class="n">withBody</span><span class="o">(</span><span class="s">"JSON description of Batman goes here"</span><span class="o">)</span>
</code></pre></div></div>

<p>There is a built-in support for HTTP body defined as String, if you wish to use other types please check out the section <a href="#custom-http-body-type">Custom HTTP body type</a>.</p>

<h2 id="http-assertions">HTTP assertions</h2>

<ul>
  <li>assert response status</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>assert response headers</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">headers</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">"cache-control"</span><span class="o">).</span><span class="n">isPresent</span>

<span class="n">headers</span><span class="o">.</span><span class="n">contain</span><span class="o">(</span><span class="s">"cache-control"</span> <span class="o">→</span> <span class="s">"no-cache"</span><span class="o">)</span>

<span class="n">headers</span><span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">"cache_control"</span><span class="o">).</span><span class="n">isAbsent</span>

<span class="n">save_header_value</span><span class="o">(</span><span class="s">"cache_control"</span> <span class="o">→</span> <span class="s">"my-cache-control-value"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>assert response body comes with different flavors (ignoring, whitelisting)</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">body</span><span class="o">.</span><span class="n">is</span><span class="o">(</span>
  <span class="s">"""
  {
    "name": "Batman",
    "realName": "Bruce Wayne",
    "city": "Gotham city",
    "hasSuperpowers": false,
    "publisher":{
      "name":"DC",
      "foundationYear":1934,
      "location":"Burbank, California"
    }
  }
  """</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">ignoring</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"hasSuperpowers"</span><span class="o">,</span> <span class="s">"publisher.foundationYear"</span><span class="o">,</span> <span class="s">"publisher.location"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span>
  <span class="s">"""
  {
    "name": "Batman",
    "realName": "Bruce Wayne",
    "publisher":{
      "name":"DC"
    }
  }
  """</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">whitelisting</span><span class="o">.</span><span class="n">is</span><span class="o">(</span>
  <span class="s">"""
  {
    "name": "Batman",
    "realName": "Bruce Wayne",
    "publisher":{
      "name":"DC"
    }
  }
  """</span><span class="o">)</span>
</code></pre></div></div>

<p>Ignored keys and extractors are JsonPaths following the format “a.b.c[index].d”.</p>

<p>The <code class="highlighter-rouge">index</code> value is either:</p>

<ul>
  <li>an Integer addressing the array position.</li>
  <li>a <code class="highlighter-rouge">*</code> to target all values, the result will be an array of the projected values.</li>
</ul>

<p>JsonPath can also be used to only assert part of the response</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"city"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="s">"Gotham city"</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"hasSuperpowers"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"publisher.name"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="s">"DC"</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"city"</span><span class="o">).</span><span class="n">containsString</span><span class="o">(</span><span class="s">"Gotham"</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"superheroes[*].name"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="s">"[ "</span><span class="nc">Spiderman</span><span class="s">", "</span><span class="nc">IronMan</span><span class="s">", "</span><span class="nc">Superman</span><span class="s">", "</span><span class="nc">GreenLantern</span><span class="s">", "</span><span class="nc">Batman</span><span class="s">" ]"</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"publisher.foundationYear"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="mi">1934</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"publisher.foundationYear"</span><span class="o">).</span><span class="n">isPresent</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"publisher.foundationMonth"</span><span class="o">).</span><span class="n">isAbsent</span>
</code></pre></div></div>

<p>If one key of the path contains a “.” it has to be wrapped with “`” to notify the parser.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"`message.en`"</span><span class="o">).</span><span class="n">isPresent</span>

<span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"`message.fr`"</span><span class="o">).</span><span class="n">isAbsent</span>
</code></pre></div></div>

<p>If the endpoint returns a collection assert response body has several options (ordered, ignoring and using data table)</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">body</span><span class="o">.</span><span class="n">asArray</span><span class="o">.</span><span class="n">inOrder</span><span class="o">.</span><span class="n">ignoringEach</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"hasSuperpowers"</span><span class="o">,</span> <span class="s">"publisher"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span>
  <span class="s">"""
  [{
    "name": "Batman",
    "realName": "Bruce Wayne"
  },
  {
    "name": "Superman",
    "realName": "Clark Kent"
  }]
  """</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">asArray</span><span class="o">.</span><span class="n">inOrder</span><span class="o">.</span><span class="n">ignoringEach</span><span class="o">(</span><span class="s">"publisher"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span>
 <span class="s">"""
  |    name     |    realName    |     city      |  hasSuperpowers |
  | "Batman"    | "Bruce Wayne"  | "Gotham city" |      false      |
  | "Superman"  | "Clark Kent"   | "Metropolis"  |      true       |
 """</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">asArray</span><span class="o">.</span><span class="n">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">body</span><span class="o">.</span><span class="n">asArray</span><span class="o">.</span><span class="n">isNotEmpty</span>

<span class="n">body</span><span class="o">.</span><span class="n">asArray</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span>
  <span class="s">"""
  {
    "name": "Batman",
    "realName": "Bruce Wayne",
    "city": "Gotham city",
    "hasSuperpowers": false,
    "publisher":{
      "name":"DC",
      "foundationYear":1934,
      "location":"Burbank, California"
    }
  }
  """</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="http-streams">HTTP streams</h2>

<ul>
  <li>Server-Sent-Event.</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">When</span> <span class="n">I</span> <span class="n">open_sse</span><span class="o">(</span><span class="n">s</span><span class="s">"http://superhero.io/stream"</span><span class="o">,</span> <span class="n">takeWithin</span> <span class="k">=</span> <span class="mf">1.</span><span class="n">seconds</span><span class="o">).</span><span class="n">withParams</span><span class="o">(</span><span class="s">"justName"</span> <span class="o">→</span> <span class="s">"true"</span><span class="o">)</span>

<span class="nc">Then</span> <span class="n">assert</span> <span class="n">body</span><span class="o">.</span><span class="n">asArray</span><span class="o">.</span><span class="n">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="nc">Then</span> <span class="n">assert</span> <span class="n">body</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="s">"""
  |   eventType      |    data     |
  | "superhero name" |  "Batman"   |
  | "superhero name" | "Superman"  |
"""</span><span class="o">)</span>
</code></pre></div></div>

<p>SSE streams are aggregated over a period of time in an array, therefore the previous array predicates can be re-used.</p>

<h2 id="graphql-support">GraphQL support</h2>

<p>Cornichon offers an integration with the library <a href="https://github.com/sangria-graphql/sangria">Sangria</a> to propose convenient features to test GraphQL API.</p>

<ul>
  <li>GraphQL query</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.macros._</span>

 <span class="nc">When</span> <span class="n">I</span> <span class="n">query_gql</span><span class="o">(</span><span class="s">"/&lt;project-key&gt;/graphql"</span><span class="o">).</span><span class="n">withQuery</span><span class="o">(</span>
    <span class="n">graphql</span><span class="s">"""
      query MyQuery {
        superheroes {
          results {
            name
            realName
            publisher {
              name
            }
          }
        }
      }
    """</span>
    <span class="o">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">query_gql</code> can also be used for mutation query.</p>

<ul>
  <li>GraphQL JSON</li>
</ul>

<p>all built-in steps accepting String input/output can also accept an alternative lightweight JSON format using the <code class="highlighter-rouge">gqljson</code> StringContext.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.agourlay.cornichon.json.CornichonJson._</span>

<span class="nc">And</span> <span class="n">assert</span> <span class="n">body</span><span class="o">.</span><span class="n">ignoring</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"publisher"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span>
  <span class="n">gqljson</span><span class="s">"""
  {
    name: "Batman",
    realName: "Bruce Wayne",
    hasSuperpowers: false
  }
  """</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="session-steps">Session steps</h2>

<ul>
  <li>setting a value in <code class="highlighter-rouge">session</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">save</span><span class="o">(</span><span class="s">"favorite-superhero"</span> <span class="o">→</span> <span class="s">"Batman"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>saving value to <code class="highlighter-rouge">session</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">save_body_path</span><span class="o">(</span><span class="s">"city"</span> <span class="o">-&gt;</span> <span class="s">"batman-city"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>asserting value in <code class="highlighter-rouge">session</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session_value</span><span class="o">(</span><span class="s">"favorite-superhero"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="s">"Batman"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>asserting JSON value in <code class="highlighter-rouge">session</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session_value</span><span class="o">(</span><span class="s">"my-json-response"</span><span class="o">).</span><span class="n">asJson</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"a.b.c"</span><span class="o">).</span><span class="n">ignoring</span><span class="o">(</span><span class="s">"d"</span><span class="o">).</span><span class="n">is</span><span class="o">(...)</span>
</code></pre></div></div>

<ul>
  <li>asserting existence of value in <code class="highlighter-rouge">session</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session_value</span><span class="o">(</span><span class="s">"favorite-superhero"</span><span class="o">).</span><span class="n">isPresent</span>
<span class="n">session_value</span><span class="o">(</span><span class="s">"favorite-superhero"</span><span class="o">).</span><span class="n">isAbsent</span>
</code></pre></div></div>

<ul>
  <li>transforming a value in <code class="highlighter-rouge">session</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">transform_session</span><span class="o">(</span><span class="s">"my-key"</span><span class="o">)(</span><span class="k">_</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="wrapper-steps">Wrapper steps</h3>

<p>Wrapper steps allow to control the execution of a series of steps to build more powerful tests.</p>

<ul>
  <li>repeating a series of <code class="highlighter-rouge">steps</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Repeat</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>repeating a series of <code class="highlighter-rouge">steps</code> during a period of time</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RepeatDuring</span><span class="o">(</span><span class="mf">300.</span><span class="n">millis</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>repeat a series of <code class="highlighter-rouge">steps</code> for each input element</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RepeatWith</span><span class="o">(</span><span class="s">"Superman"</span><span class="o">,</span> <span class="s">"GreenLantern"</span><span class="o">,</span> <span class="s">"Spiderman"</span><span class="o">)(</span><span class="s">"superhero-name"</span><span class="o">)</span> <span class="o">{</span>

  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"/superheroes/&lt;superhero-name&gt;"</span><span class="o">).</span><span class="n">withParams</span><span class="o">(</span><span class="s">"sessionId"</span> <span class="o">→</span> <span class="s">"&lt;session-id&gt;"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"hasSuperpowers"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>retry a series of <code class="highlighter-rouge">steps</code> until it succeeds or reaches the limit</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RetryMax</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>repeating a series of <code class="highlighter-rouge">steps</code> until it succeeds over a period of time at a specified interval (handy for eventually consistent endpoints)</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Eventually</span><span class="o">(</span><span class="n">maxDuration</span> <span class="k">=</span> <span class="mf">15.</span><span class="n">seconds</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mf">200.</span><span class="n">milliseconds</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/random"</span><span class="o">)</span>

    <span class="nc">Then</span> <span class="n">assert</span> <span class="n">body</span><span class="o">.</span><span class="n">ignoring</span><span class="o">(</span><span class="s">"hasSuperpowers"</span><span class="o">,</span> <span class="s">"publisher"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span>
      <span class="s">"""
      {
        "name": "Batman",
        "realName": "Bruce Wayne",
        "city": "Gotham city"
      }
      """</span>
    <span class="o">)</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>execute a series of steps ‘n’ times concurrently and wait ‘maxTime’ for completion.</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Concurrently</span><span class="o">(</span><span class="n">factor</span> <span class="k">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">maxTime</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>

  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>execute a series of steps and fails if the execution does not complete within ‘maxDuration’.</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Within</span><span class="o">(</span><span class="n">maxDuration</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>

  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>repeat a series of steps with different inputs specified via a datatable</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">WithDataInputs</span><span class="o">(</span>
  <span class="s">"""
    | a | b  | c  |
    | 1 | 3  | 4  |
    | 7 | 4  | 11 |
    | 1 | -1 | 0  |
  """</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">a_plus_b_equals_c</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">a_plus_b_equals_c</span> <span class="k">=</span>
  <span class="nc">AssertStep</span><span class="o">(</span><span class="s">"sum of 'a' + 'b' = 'c'"</span><span class="o">,</span> <span class="n">s</span> <span class="k">⇒</span> <span class="nc">GenericEqualityAssertion</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">getUnsafe</span><span class="o">(</span><span class="s">"a"</span><span class="o">).</span><span class="n">toInt</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">getUnsafe</span><span class="o">(</span><span class="s">"b"</span><span class="o">).</span><span class="n">toInt</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">getUnsafe</span><span class="o">(</span><span class="s">"c"</span><span class="o">).</span><span class="n">toInt</span><span class="o">))</span>
</code></pre></div></div>

<ul>
  <li>WithHeaders automatically sets headers for several steps useful for authenticated scenario.</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">WithHeaders</span><span class="o">((</span><span class="s">"Authorization"</span><span class="o">,</span> <span class="s">"Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ=="</span><span class="o">)){</span>
  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/secured"</span><span class="o">)</span>
  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>WithBasicAuth automatically sets basic auth headers for several steps.</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">WithBasicAuth</span><span class="o">(</span><span class="s">"admin"</span><span class="o">,</span> <span class="s">"root"</span><span class="o">){</span>
  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/secured"</span><span class="o">)</span>
  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>HttpListenTo creates an HTTP server that will be running during the length of the enclosed steps.</li>
</ul>

<p>This feature is defined the module <code class="highlighter-rouge">cornichon-http-mock</code> and requires to extend the trait <code class="highlighter-rouge">HttpMockDsl</code>.</p>

<p>By default this server responds with 201 to any POST request and 200 for all the rest.</p>

<p>Additionally it provides three administrations features:</p>
<ul>
  <li>fetching recorded received requests</li>
  <li>resetting recorded received requests</li>
  <li>toggling on/off the error mode to return HTTP 500 to incoming requests</li>
</ul>

<p>The server records all requests received as a JSON array of HTTP request for later assertions.</p>

<p>There are two ways to perform assertions on the server statistics, either by querying the session at the end of the block or by contacting directly the server while it runs.</p>

<p>Refer to those <a href="https://github.com/agourlay/cornichon-http-mock/blob/master/src/test/scala/com/github/agourlay/cornichon/examples/MockServerExample.scala">examples</a> for more information.</p>

<p>This feature is experimental and subject to changes.</p>

<ul>
  <li>Log duration</li>
</ul>

<p>By default all <code class="highlighter-rouge">Step</code> execution time can be found in the logs, but sometimes one needs to time a series of steps.</p>

<p>This is where <code class="highlighter-rouge">LogDuration</code> comes in handy, it requires a label that will be printed as well to identify results.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">LogDuration</span><span class="o">(</span><span class="n">label</span> <span class="k">=</span> <span class="s">"my experiment"</span><span class="o">)</span> <span class="o">{</span>

  <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"http://superhero.io/batman"</span><span class="o">)</span>

  <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="debug-steps">Debug steps</h2>

<ul>
  <li>showing session content for debugging purpose</li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">And</span> <span class="n">I</span> <span class="n">show_session</span>

 <span class="nc">And</span> <span class="n">I</span> <span class="n">show_last_response</span>

 <span class="nc">And</span> <span class="n">I</span> <span class="n">show_last_response_json</span> <span class="o">(</span><span class="n">pretty</span> <span class="n">print</span> <span class="n">the</span> <span class="n">json</span> <span class="n">body</span><span class="o">)</span>

 <span class="nc">And</span> <span class="n">I</span> <span class="n">show_last_status</span>

 <span class="nc">And</span> <span class="n">I</span> <span class="n">show_last_body</span>

 <span class="nc">And</span> <span class="n">I</span> <span class="n">show_last_body_json</span> <span class="o">(</span><span class="n">pretty</span> <span class="n">print</span> <span class="n">the</span> <span class="n">json</span> <span class="n">body</span><span class="o">)</span>

 <span class="nc">And</span> <span class="n">I</span> <span class="n">show_last_headers</span>
</code></pre></div></div>

<p>Those descriptions might be already outdated, in case of doubt always refer to those <a href="https://github.com/agourlay/cornichon/blob/master/src/test/scala/com/github/agourlay/cornichon/examples/superHeroes/SuperHeroesScenario.scala">examples</a> as they are executed as part of Cornichon’s test suite.</p>

<h2 id="dsl-composition">DSL composition</h2>

<p>Series of steps defined with Cornichon’s DSL can be reused within different <code class="highlighter-rouge">Scenarios</code>.</p>

<p>Using the keyword <code class="highlighter-rouge">Attach</code> if the series starts with a <code class="highlighter-rouge">Step</code> and without if it starts with a wrapping bloc.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.github.agourlay.cornichon.CornichonFeature</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">class</span> <span class="nc">CompositionFeature</span> <span class="k">extends</span> <span class="nc">CornichonFeature</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">feature</span> <span class="k">=</span>
    <span class="nc">Feature</span><span class="o">(</span><span class="s">"Cornichon feature example"</span><span class="o">)</span> <span class="o">{</span>

      <span class="nc">Scenario</span><span class="o">(</span><span class="s">"demonstrate DSL composition"</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Then</span> <span class="n">assert</span> <span class="n">superhero_exists</span><span class="o">(</span><span class="s">"batman"</span><span class="o">)</span>

        <span class="nc">Then</span> <span class="n">assert</span> <span class="n">random_superheroes_until</span><span class="o">(</span><span class="s">"Batman"</span><span class="o">)</span>

      <span class="o">}</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">superhero_exists</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
    <span class="nc">Attach</span> <span class="o">{</span>
      <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="n">s</span><span class="s">"/superheroes/$name"</span><span class="o">).</span><span class="n">withParams</span><span class="o">(</span><span class="s">"sessionId"</span> <span class="o">→</span> <span class="s">"&lt;session-id&gt;"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">is</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">random_superheroes_until</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
    <span class="nc">Eventually</span><span class="o">(</span><span class="n">maxDuration</span> <span class="k">=</span> <span class="mi">3</span> <span class="n">seconds</span><span class="o">,</span> <span class="n">interval</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">When</span> <span class="n">I</span> <span class="n">get</span><span class="o">(</span><span class="s">"/superheroes/random"</span><span class="o">).</span><span class="n">withParams</span><span class="o">(</span><span class="s">"sessionId"</span> <span class="o">→</span> <span class="s">"&lt;session-id&gt;"</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">assert</span> <span class="n">body</span><span class="o">.</span><span class="n">path</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="n">is</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
      <span class="nc">Then</span> <span class="n">I</span> <span class="n">print_step</span><span class="o">(</span><span class="s">"bingo!"</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It is possible to give a title to an attached bloc using <code class="highlighter-rouge">AttachAs(title)</code>.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/cornichon/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'agourlay/cornichon'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cornichon/js/main.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>